<!doctype html>
<html>
    <head>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
        <!-- 依存関係のスクリプトの順番を変更 -->
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <!-- ユーザー操作プロンプト -->
        <div id="audio-prompt" style="
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        ">
            <button style="font-size: 20px; padding: 10px 20px;" onclick="initializeAudio()">音声を再生する</button>
        </div>

        <a-scene
            embedded
            arjs="trackingMethod: best; sourceType: webcam;"
            gesture-detector
        >
            <a-assets>
                <!-- モデルと音声を登録 -->
                <a-asset-item id="model" src="assets/asset.glb"></a-asset-item>
                <audio id="background-music" src="assets/sound.mp3" preload="auto"></audio>
            </a-assets>

            <!-- マーカー -->
            <a-marker
                id="marker"
                type="pattern"
                url="assets/marker.patt"
                emitevents="true"
            >
                <a-entity
                    gltf-model="#model"
                    scale="0.5 0.5 0.5"
                >
                    <a-sound
                        id="sound-effect"
                        src="#background-music"
                        autoplay="false"
                        loop="true"
                        volume="1.0"
                    ></a-sound>
                </a-entity>
            </a-marker>

            <a-entity camera></a-entity>
        </a-scene>

        <script>
          let audioInitialized = false; // 音声初期化フラグ

          function initializeAudio() {
            const sound = document.querySelector("#sound-effect");

            // 音声を初期化
            if (sound && !audioInitialized) {
              const audioElement = document.querySelector("#background-music");
              audioElement.load(); // 音声をロード

              // ユーザー操作による再生確認
              audioElement.play().then(() => {
                console.log("音声が初期化されました");
                sound.components.sound.playSound(); // 音声を再生
                audioInitialized = true;
              }).catch((error) => {
                console.error("音声の再生に失敗しました:", error);
              });
            }

            // プロンプトを非表示にする
            document.getElementById("audio-prompt").style.display = "none";
          }

          // マーカー検出時の音声再生
          AFRAME.registerComponent("play-sound-on-marker", {
            init: function () {
              this.el.addEventListener("markerFound", () => {
                const sound = document.querySelector("#sound-effect");
                if (sound && audioInitialized) {
                  console.log("マーカーが検出されました。音声を再生します。");
                  sound.components.sound.playSound();
                }
              });

              this.el.addEventListener("markerLost", () => {
                const sound = document.querySelector("#sound-effect");
                if (sound && audioInitialized) {
                  console.log("マーカーが見失われました。音声を停止します。");
                  sound.components.sound.stopSound();
                }
              });
            },
          });

          // マーカーにカスタムコンポーネントを追加
          document.querySelector("#marker").setAttribute("play-sound-on-marker", "");
        </script>
    </body>
</html>
